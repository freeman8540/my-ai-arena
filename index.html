 <!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Arena å®æ—¶è‰ç¨¿ç‰ˆ V12.0</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <style>
        /* --- åŸºç¡€æ ·å¼ (ä¿æŒ V11 é£æ ¼) --- */
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background-color: #f4f6f8; color: #333; padding-bottom: 100px; }
        .main-container { max-width: 98%; margin: 20px auto; display: flex; flex-direction: column; gap: 25px; }
        .box { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); border: 1px solid #e1e4e8; }
        h1 { text-align: center; color: #2c3e50; margin-bottom: 20px; }

        /* è‰ç¨¿çŠ¶æ€æç¤º */
        .draft-status {
            font-size: 12px; color: #888; text-align: right; margin-bottom: 10px; font-style: italic;
        }
        .draft-status.saving { color: #FF9800; }
        .draft-status.saved { color: #4CAF50; }

        /* å¯¼å‡ºæŒ‰é’®ç»„ */
        .export-section { background: #f1f8e9; padding: 15px; border-radius: 8px; border: 1px solid #c5e1a5; margin-bottom: 20px; }
        .export-buttons { display: flex; gap: 15px; margin-top: 10px; }
        .btn-exp { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 5px;}
        .btn-exp-left { background: #1976D2; } .btn-exp-right { background: #7B1FA2; } .btn-exp-json { background: #607D8B; }

        /* API & æµ®çª— */
        .api-panel { background: #263238; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: none; }
        .api-panel.show { display: block; }
        .api-input { width: 100%; padding: 10px; border-radius: 4px; border: 1px solid #546E7A; background: #37474F; color: white; box-sizing: border-box; }
        .btn-toggle-config { background: #333; color: white; border:none; padding: 8px 20px; border-radius: 20px; cursor: pointer; margin: 0 auto; display: block;}
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 80%; max-width: 800px; max-height: 80vh; border-radius: 10px; padding: 20px; display: flex; flex-direction: column; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .modal-body { overflow-y: auto; flex: 1; border: 1px solid #eee; padding: 15px; border-radius: 6px; background: #fafafa; margin: 15px 0; }
        .modal-footer { display: flex; justify-content: flex-end; gap: 10px; }

        /* åŒæ¨¡æ€è¾“å…¥æ¡† */
        .input-wrapper { position: relative; border: 1px solid #ccc; border-top: none; border-radius: 0 0 6px 6px; background: #fff; }
        textarea { padding: 15px; border: none; font-family: 'Consolas', monospace; font-size: 15px; line-height: 1.5; box-sizing: border-box; resize: vertical; width: 100%; display: block; outline: none; }
        .textarea-half { height: 350px; }
        .preview-layer { padding: 15px; height: 350px; overflow-y: auto; display: none; background: #fff; cursor: text; }
        .show-preview .preview-layer { display: block; }
        .show-preview textarea { display: none; }

        /* å·¥å…·æ  */
        .toolbar { display: flex; justify-content: space-between; align-items: center; background: #f5f5f5; padding: 5px 10px; border-radius: 6px 6px 0 0; border: 1px solid #ccc; border-bottom: 1px solid #ddd; }
        .toolbar-actions { display: flex; gap: 8px; align-items: center; }
        .btn-icon { border: 1px solid #ccc; background: white; padding: 4px 8px; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .btn-icon:hover { background: #e3f2fd; border-color: #2196F3; }
        .btn-icon.active { background: #2196F3; color: white; border-color: #2196F3; }
        .btn-magic { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; }

        /* å¸ƒå±€ä¸é€šç”¨ */
        .round-container { border: 1px solid #ccc; background: #fff; padding: 20px; margin-bottom: 20px; border-radius: 10px; position: relative; }
        .round-label { position: absolute; top: -10px; left: 15px; background: #455A64; color: white; padding: 2px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; }
        .grid-2-col { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .textarea-full { height: 100px; margin-bottom: 15px; border-radius: 6px; border: 1px solid #ccc; padding:10px;}
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; }
        .record-item { margin-bottom: 30px; border-left: 6px solid #ddd; }
        .win-Left { border-left-color: #2196F3; } .win-Right { border-left-color: #9C27B0; }
        .markdown-body { font-size: 14px; line-height: 1.6; }
        .markdown-body pre { background: #2d2d2d; color: #f8f8f2; padding: 10px; border-radius: 4px; overflow-x: auto; }
        
        #status { position: fixed; top: 20px; right: 20px; padding: 12px 20px; background: #4CAF50; color: white; border-radius: 4px; display: none; z-index: 999; font-weight: bold;}
    </style>
</head>
<body>

<div id="status"></div>

<!-- é¢„è§ˆæµ®çª— -->
<div class="modal-overlay" id="previewModal">
    <div class="modal-content">
        <h3 style="margin:0; color:#2196F3;">âœ¨ AI æ€»ç»“é¢„è§ˆ</h3>
        <div class="modal-body markdown-body" id="previewContent"></div>
        <div class="modal-footer">
            <button class="btn" style="background:#eee;" onclick="closeModal()">âŒ å–æ¶ˆ</button>
            <button class="btn" style="background:#2196F3; color:white;" onclick="confirmSummary()">âœ… é‡‡ç”¨å¹¶æ˜¾ç¤º</button>
        </div>
    </div>
</div>

<div class="main-container">
    <h1>âš”ï¸ Arena å®æ—¶è‰ç¨¿ç‰ˆ V12.0</h1>
    <button class="btn-toggle-config" onclick="document.getElementById('configPanel').classList.toggle('show')">âš™ï¸ è®¾ç½® API</button>

    <div class="api-panel" id="configPanel">
        <div style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:20px; margin-bottom:15px;">
            <input type="text" id="apiBase" class="api-input" value="https://api.deepseek.com">
            <input type="password" id="apiKey" class="api-input" placeholder="sk-...">
            <input type="text" id="apiModel" class="api-input" value="deepseek-chat">
        </div>
        <textarea id="systemPrompt" class="api-input" style="height:80px;">ä½ æ˜¯ä¸€ä¸ªæŠ€æœ¯æ€»ç»“ä¸“å®¶ã€‚è¯·ä¿ç•™æ ¸å¿ƒç»†èŠ‚ï¼Œä½¿ç”¨æ¸…æ™°çš„ Markdown åˆ—è¡¨æ ¼å¼ï¼Œé‡ç‚¹è¯æ±‡åŠ ç²—ï¼Œå»é™¤åºŸè¯ã€‚</textarea>
        <div style="margin-top:10px; text-align:right;">
            <button class="btn" style="background:#4CAF50; color:white;" onclick="saveApiConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
        </div>
    </div>

    <div class="box" id="input-box">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
            <div id="draftStatus" class="draft-status saved">âœ“ è‰ç¨¿å·²è‡ªåŠ¨ä¿å­˜</div>
            <button class="btn" style="background:#FF9800; color:white; font-size:12px; padding:5px 10px;" onclick="clearDraft()">âš ï¸ æ¸…ç©ºè‰ç¨¿</button>
        </div>

        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:20px; margin-bottom:20px;">
            <input type="text" id="nameA" style="padding:10px; text-align:center; font-weight:bold; width:100%; border:1px solid #ddd; border-radius:4px;" value="Model A">
            <input type="text" id="nameB" style="padding:10px; text-align:center; font-weight:bold; width:100%; border:1px solid #ddd; border-radius:4px;" value="Model B">
        </div>

        <div id="rounds-wrapper"></div>

        <button class="btn" style="background:#673AB7; color:white; width:100%; margin-bottom:20px;" onclick="addRound()">â• æ·»åŠ ä¸‹ä¸€è½®å¯¹è¯</button>

        <div style="text-align:center; margin:20px 0; background:#f9f9f9; padding:10px; border-radius:8px;">
            <label style="margin-right:15px;"><input type="radio" name="winner" value="None" checked> âšª æš‚ä¸è¯„ä»·</label>
            <label style="margin-right:15px;"><input type="radio" name="winner" value="Left"> ğŸ”µ å·¦è¾¹èµ¢</label>
            <label style="margin-right:15px;"><input type="radio" name="winner" value="Right"> ğŸŸ£ å³è¾¹èµ¢</label>
            <label style="margin-right:15px;"><input type="radio" name="winner" value="Tie"> ğŸŸ  å¹³å±€</label>
        </div>
        
        <input type="hidden" id="edit-id" value="">
        <div style="display:flex; gap:10px;">
            <button class="btn" style="background:#2196F3; color:white; width:100%; font-size:16px;" onclick="archiveRecord()">âœ… ç»“æŸå¯¹è¯å¹¶å½’æ¡£ (Save & Clear)</button>
        </div>
    </div>

    <div class="box">
        <h2>ğŸ“š å†å²è®°å½• (<span id="count">0</span>)</h2>
        
        <!-- å¯¼å‡ºåŠŸèƒ½ -->
        <div class="export-section">
            <div style="font-size:14px; font-weight:bold; color:#558B2F; margin-bottom:5px;">ğŸ“¤ æ•°æ®å¯¼å‡ºä¸­å¿ƒ</div>
            <div class="export-buttons">
                <button class="btn-exp btn-exp-left" onclick="exportSplit('Left')">ğŸ“„ ä»…å¯¼å‡ºå·¦è¾¹</button>
                <button class="btn-exp btn-exp-right" onclick="exportSplit('Right')">ğŸ“„ ä»…å¯¼å‡ºå³è¾¹</button>
                <button class="btn-exp btn-exp-json" onclick="exportAllJson()">ğŸ“¦ å¯¼å‡ºå…¨éƒ¨å¤‡ä»½</button>
            </div>
        </div>

        <div id="record-list"></div>
    </div>
</div>

<script>
    // å…¨å±€æš‚å­˜
    let tempSummary = '', targetId = '', targetReplaceMode = '', targetOriginal = '';
    // è‰ç¨¿é˜²æŠ–å®šæ—¶å™¨
    let saveDraftTimer = null;

    marked.setOptions({
        highlight: (code, lang) => {
            const language = hljs.getLanguage(lang) ? lang : 'plaintext';
            return hljs.highlight(code, { language }).value;
        }
    });

    let records = JSON.parse(localStorage.getItem('arenaRecordsV12') || '[]');

    window.onload = () => {
        loadApiConfig();
        
        // ğŸ”¥ æ ¸å¿ƒå‡çº§ï¼šå…ˆå°è¯•åŠ è½½è‰ç¨¿ï¼Œå¦‚æœæ²¡æœ‰è‰ç¨¿ï¼Œå†åˆå§‹åŒ–ç©ºè½®æ¬¡
        if (!loadDraft()) {
            addRound();
        }
        
        renderRecords();
    };

    // --- ğŸ”¥ å®æ—¶è‰ç¨¿é€»è¾‘ ---
    
    // ç›‘å¬æ‰€æœ‰è¾“å…¥æ¡†çš„å˜åŒ–
    document.getElementById('input-box').addEventListener('input', () => {
        updateDraftStatus('saving');
        clearTimeout(saveDraftTimer);
        saveDraftTimer = setTimeout(saveDraft, 1000); // 1ç§’åè‡ªåŠ¨ä¿å­˜
    });

    function saveDraft() {
        const nameA = document.getElementById('nameA').value;
        const nameB = document.getElementById('nameB').value;
        const winner = document.querySelector('input[name="winner"]:checked').value;
        const editId = document.getElementById('edit-id').value;
        
        const turns = [];
        document.querySelectorAll('.round-container').forEach((div) => {
            turns.push({
                prompt: div.querySelector('.prompt-in').value,
                replyA: div.querySelector('.replyA-in').value,
                replyB: div.querySelector('.replyB-in').value
            });
        });

        const draftData = { nameA, nameB, winner, editId, turns, timestamp: Date.now() };
        localStorage.setItem('arenaDraftV12', JSON.stringify(draftData));
        updateDraftStatus('saved');
    }

    function loadDraft() {
        const draftStr = localStorage.getItem('arenaDraftV12');
        if (!draftStr) return false;
        
        try {
            const draft = JSON.parse(draftStr);
            // å¦‚æœè‰ç¨¿æ˜¯ç©ºçš„ï¼Œå°±ä¸åŠ è½½
            if (draft.turns.length === 0 || (!draft.turns[0].prompt && !draft.turns[0].replyA)) return false;

            document.getElementById('nameA').value = draft.nameA || 'Model A';
            document.getElementById('nameB').value = draft.nameB || 'Model B';
            document.getElementById('edit-id').value = draft.editId || '';
            
            const radios = document.getElementsByName('winner');
            for(let r of radios) if(r.value === draft.winner) r.checked = true;

            document.getElementById('rounds-wrapper').innerHTML = '';
            draft.turns.forEach(turn => addRound(turn));
            
            showToast('ğŸ”„ å·²æ¢å¤æœªä¿å­˜çš„è‰ç¨¿');
            return true;
        } catch(e) {
            console.error('è‰ç¨¿åŠ è½½å¤±è´¥', e);
            return false;
        }
    }

    function clearDraft() {
        if(confirm('ç¡®å®šæ¸…ç©ºå½“å‰è‰ç¨¿å—ï¼Ÿï¼ˆä¸å¯æ¢å¤ï¼‰')) {
            localStorage.removeItem('arenaDraftV12');
            resetForm();
        }
    }

    function updateDraftStatus(status) {
        const el = document.getElementById('draftStatus');
        if (status === 'saving') {
            el.textContent = '...æ­£åœ¨ä¿å­˜è‰ç¨¿';
            el.className = 'draft-status saving';
        } else {
            el.textContent = 'âœ“ è‰ç¨¿å·²è‡ªåŠ¨ä¿å­˜';
            el.className = 'draft-status saved';
        }
    }

    // --- å½’æ¡£é€»è¾‘ (æ›¿ä»£åŸæ¥çš„ Save) ---
    function archiveRecord() {
        const turns = [];
        document.querySelectorAll('.round-container').forEach((div, idx) => {
            turns.push({
                round: idx+1,
                prompt: div.querySelector('.prompt-in').value,
                replyA: div.querySelector('.replyA-in').value,
                replyB: div.querySelector('.replyB-in').value
            });
        });
        
        // ç®€å•çš„ç©ºå€¼æ£€æŸ¥
        if(!turns[0].prompt && !turns[0].replyA) return alert('æ¡†é‡Œæ˜¯ç©ºçš„ï¼Œæ²¡æ³•å½’æ¡£');

        const rec = {
            id: document.getElementById('edit-id').value || Date.now(),
            time: new Date().toLocaleString(),
            nameA: document.getElementById('nameA').value,
            nameB: document.getElementById('nameB').value,
            winner: document.querySelector('input[name="winner"]:checked').value,
            turns
        };

        const existingIdx = records.findIndex(r => r.id == rec.id);
        if(existingIdx !== -1) records[existingIdx] = rec;
        else records.unshift(rec);

        localStorage.setItem('arenaRecordsV12', JSON.stringify(records));
        
        // ğŸ”¥ å½’æ¡£åï¼Œæ¸…ç©ºè‰ç¨¿ï¼Œé‡ç½®è¡¨å•
        localStorage.removeItem('arenaDraftV12');
        renderRecords();
        resetForm();
        showToast('âœ… å¯¹è¯å·²å½’æ¡£è‡³å†å²è®°å½•');
    }

    // --- å…¶ä»–åŸæœ‰é€»è¾‘ (ä¿æŒä¸å˜) ---
    
    // è§†å›¾åˆ‡æ¢
    function toggleView(uniqueId, mode) {
        const wrapper = document.getElementById(`wrapper-${uniqueId}`);
        const textarea = document.getElementById(uniqueId);
        const preview = document.getElementById(`preview-${uniqueId}`);
        const btnEdit = document.getElementById(`btn-edit-${uniqueId}`);
        const btnPreview = document.getElementById(`btn-preview-${uniqueId}`);

        if(mode === 'preview') {
            const text = textarea.value;
            preview.innerHTML = !text.trim() ? '<span style="color:#ccc;">(ç©º)</span>' : marked.parse(text);
            wrapper.classList.add('show-preview');
            btnPreview.classList.add('active');
            btnEdit.classList.remove('active');
        } else {
            wrapper.classList.remove('show-preview');
            btnEdit.classList.add('active');
            btnPreview.classList.remove('active');
            textarea.focus();
        }
    }

    // API æ€»ç»“
    async function summarizeText(uniqueId, btn) {
        const textarea = document.getElementById(uniqueId);
        if(!textarea.value.trim()) return alert('æ²¡å†…å®¹');
        const apiKey = document.getElementById('apiKey').value;
        if(!apiKey) return alert('è¯·è®¾ç½® API Key');

        const originBtn = btn.innerHTML;
        btn.innerHTML = 'ğŸ§ ...';
        
        try {
            const res = await fetch(document.getElementById('apiBase').value + '/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                body: JSON.stringify({
                    model: document.getElementById('apiModel').value,
                    messages: [
                        { role: "system", content: document.getElementById('systemPrompt').value },
                        { role: "user", content: textarea.value }
                    ],
                    temperature: 0.3
                })
            });
            const data = await res.json();
            if(data.error) throw new Error(data.error.message);
            
            tempSummary = data.choices[0].message.content;
            targetId = uniqueId;
            targetReplaceMode = document.querySelector(`input[name="replace-${uniqueId}"]:checked`).value;
            targetOriginal = textarea.value;

            document.getElementById('previewContent').innerHTML = marked.parse(tempSummary);
            document.getElementById('previewModal').style.display = 'flex';
        } catch(e) { alert(e.message); } 
        finally { btn.innerHTML = originBtn; }
    }

    function closeModal() { document.getElementById('previewModal').style.display = 'none'; }

    function confirmSummary() {
        const textarea = document.getElementById(targetId);
        if(targetReplaceMode === 'replace') textarea.value = tempSummary;
        else textarea.value = targetOriginal + "\n\n---\n### ğŸ¤– AI æ€»ç»“:\n" + tempSummary;
        closeModal();
        toggleView(targetId, 'preview');
        saveDraft(); // ä¿®æ”¹åç«‹å³è§¦å‘è‰ç¨¿ä¿å­˜
    }

    // åŠ¨æ€æ·»åŠ è½®æ¬¡
    function addRound(data = null) {
        const wrapper = document.getElementById('rounds-wrapper');
        const idx = wrapper.children.length + 1;
        const idA = `inputA-${Date.now()}`;
        const idB = `inputB-${Date.now()}`;

        const div = document.createElement('div');
        div.className = 'round-container';
        div.innerHTML = `
            <div class="round-label">Round #${idx}</div>
            ${idx > 1 ? '<button style="position:absolute;top:10px;right:10px;border:none;background:transparent;cursor:pointer;" onclick="this.parentElement.remove();saveDraft();">ğŸ—‘ï¸</button>' : ''}
            
            <div style="margin-bottom:15px;">
                <label style="font-weight:bold;display:block;margin-bottom:5px;">ğŸ—£ï¸ Prompt:</label>
                <textarea class="textarea-full prompt-in">${data ? data.prompt : ''}</textarea>
            </div>

            <div class="grid-2-col">
                <div>
                    <div class="toolbar">
                        <label class="label-A">ğŸ”µ å·¦è¾¹</label>
                        <div class="toolbar-actions">
                            <button class="btn-icon active" id="btn-edit-${idA}" onclick="toggleView('${idA}', 'edit')">âœï¸</button>
                            <button class="btn-icon" id="btn-preview-${idA}" onclick="toggleView('${idA}', 'preview')">ğŸ‘ï¸</button>
                            <span style="width:1px;height:15px;background:#ddd;margin:0 5px;"></span>
                            <label style="font-size:12px;"><input type="radio" name="replace-${idA}" value="replace" checked> æ¢</label>
                            <label style="font-size:12px;"><input type="radio" name="replace-${idA}" value="append"> åŠ </label>
                            <button class="btn-icon btn-magic" onclick="summarizeText('${idA}', this)">âœ¨</button>
                        </div>
                    </div>
                    <div id="wrapper-${idA}" class="input-wrapper">
                        <textarea id="${idA}" class="textarea-half replyA-in" placeholder="Markdown ç¼–è¾‘æ¨¡å¼...">${data ? data.replyA : ''}</textarea>
                        <div id="preview-${idA}" class="preview-layer markdown-body"></div>
                    </div>
                </div>
                <div>
                    <div class="toolbar">
                        <label class="label-B">ğŸŸ£ å³è¾¹</label>
                        <div class="toolbar-actions">
                            <button class="btn-icon active" id="btn-edit-${idB}" onclick="toggleView('${idB}', 'edit')">âœï¸</button>
                            <button class="btn-icon" id="btn-preview-${idB}" onclick="toggleView('${idB}', 'preview')">ğŸ‘ï¸</button>
                            <span style="width:1px;height:15px;background:#ddd;margin:0 5px;"></span>
                            <label style="font-size:12px;"><input type="radio" name="replace-${idB}" value="replace" checked> æ¢</label>
                            <label style="font-size:12px;"><input type="radio" name="replace-${idB}" value="append"> åŠ </label>
                            <button class="btn-icon btn-magic" onclick="summarizeText('${idB}', this)">âœ¨</button>
                        </div>
                    </div>
                    <div id="wrapper-${idB}" class="input-wrapper">
                        <textarea id="${idB}" class="textarea-half replyB-in" placeholder="Markdown ç¼–è¾‘æ¨¡å¼...">${data ? data.replyB : ''}</textarea>
                        <div id="preview-${idB}" class="preview-layer markdown-body"></div>
                    </div>
                </div>
            </div>
        `;
        wrapper.appendChild(div);
        updateLabels();
    }

    function saveApiConfig() {
        localStorage.setItem('arenaApiConfigV12', JSON.stringify({
            base: document.getElementById('apiBase').value,
            key: document.getElementById('apiKey').value,
            model: document.getElementById('apiModel').value,
            prompt: document.getElementById('systemPrompt').value
        }));
        showToast('âœ… API é…ç½®å·²ä¿å­˜');
    }

    function loadApiConfig() {
        const c = JSON.parse(localStorage.getItem('arenaApiConfigV12'));
        if(c) {
            document.getElementById('apiBase').value = c.base;
            document.getElementById('apiKey').value = c.key;
            document.getElementById('apiModel').value = c.model;
            if(c.prompt) document.getElementById('systemPrompt').value = c.prompt;
        }
    }

    document.getElementById('nameA').addEventListener('input', updateLabels);
    document.getElementById('nameB').addEventListener('input', updateLabels);
    function updateLabels() {
        const nA = document.getElementById('nameA').value;
        const nB = document.getElementById('nameB').value;
        document.querySelectorAll('.label-A').forEach(el => el.textContent = 'ğŸ”µ ' + nA);
        document.querySelectorAll('.label-B').forEach(el => el.textContent = 'ğŸŸ£ ' + nB);
        saveDraft(); // åå­—å˜äº†ä¹Ÿå­˜è‰ç¨¿
    }

    function renderRecords() {
        const list = document.getElementById('record-list');
        document.getElementById('count').textContent = records.length;
        list.innerHTML = '';
        records.forEach((r, index) => {
            let h = '';
            r.turns.forEach(t => {
                h += `<div style="margin-bottom:20px;border-bottom:1px dashed #eee;padding-bottom:10px;">
                    <div style="background:#e3f2fd;padding:10px;border-radius:5px;margin-bottom:10px;"><strong>User:</strong> ${marked.parse(t.prompt)}</div>
                    <div class="grid-2-col">
                        <div class="markdown-body"><strong>${r.nameA}:</strong> ${marked.parse(t.replyA||'')}</div>
                        <div class="markdown-body"><strong>${r.nameB}:</strong> ${marked.parse(t.replyB||'')}</div>
                    </div>
                </div>`;
            });
            const d = document.createElement('div');
            d.className = `record-item win-${r.winner}`;
            d.innerHTML = `<div class="record-header" onclick="this.nextElementSibling.classList.toggle('show')"><div>${r.time} | ${r.nameA} vs ${r.nameB}</div><small>â–¼</small></div><div class="chat-flow">${h}<div style="text-align:right;"><button class="btn" style="background:#eee;" onclick="editRecord(${r.id})">âœï¸</button> <button class="btn" style="background:#faa;" onclick="delRecord(${index})">ğŸ—‘ï¸</button></div></div>`;
            list.appendChild(d);
        });
    }

    function editRecord(id) {
        const r = records.find(i => i.id === id);
        if(!r) return;
        // ç¼–è¾‘æ—¶ï¼ŒæŠŠæ—§è®°å½•åŠ è½½è¿›è‰ç¨¿åŒºï¼Œç›¸å½“äº"é‡æ–°æ¿€æ´»è‰ç¨¿"
        document.getElementById('edit-id').value = r.id;
        document.getElementById('nameA').value = r.nameA;
        document.getElementById('nameB').value = r.nameB;
        updateLabels();
        document.getElementById('rounds-wrapper').innerHTML = '';
        r.turns.forEach(t => addRound(t));
        window.scrollTo({top:0, behavior:'smooth'});
        saveDraft(); // ç«‹å³å­˜ä¸ºè‰ç¨¿ï¼Œé˜²æ­¢ç¼–è¾‘ä¸¢å¤±
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('rounds-wrapper').innerHTML = '';
        addRound();
        updateDraftStatus('saved');
    }
    function delRecord(i) { records.splice(i, 1); localStorage.setItem('arenaRecordsV12', JSON.stringify(records)); renderRecords(); }
    
    function exportSplit(side) {
        if (records.length === 0) return alert('è¿˜æ²¡æœ‰è®°å½•å¯ä»¥å¯¼å‡º');
        let content = `# Arena å¯¼å‡º - ${side === 'Left' ? 'å·¦ä¾§' : 'å³ä¾§'}\n\n`;
        records.forEach((r, index) => {
            const modelName = side === 'Left' ? r.nameA : r.nameB;
            content += `## Session ${records.length - index} (${r.time})\n`;
            r.turns.forEach(turn => {
                const reply = side === 'Left' ? turn.replyA : turn.replyB;
                content += `### User:\n${turn.prompt}\n\n### ${modelName}:\n${reply || '(ç©º)'}\n\n---\n\n`;
            });
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([content], { type: 'text/markdown' }));
        a.download = `Arena_Export_${side}_${Date.now()}.md`; a.click();
    }

    function exportAllJson() {
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([JSON.stringify(records, null, 2)], {type:'application/json'}));
        a.download = `Backup_${Date.now()}.json`; a.click();
    }
    
    function showToast(m) { const e=document.getElementById('status'); e.textContent=m; e.style.display='block'; setTimeout(()=>e.style.display='none',2000); }
</script>

</body>
</html>
